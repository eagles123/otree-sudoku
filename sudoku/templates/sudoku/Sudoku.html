{% extends "global/Page.html" %}
{% load otree static %}

{% block content %}
<script type='text/javascript' src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
{#<script type='text/javascript'>#}
{#    $(document).ready(function(){#}
{##}
{#        $('.sd input').each(function (){#}
{#            if ($(this).val() === '0') {#}
{#            $(this).val('');#}
{#        };#}
{#        });#}
{#    });#}
{#</script>#}
    <style>
        td:first-child {
                border-left:solid;
            }
            td:nth-child(2n) {
                border-right:solid ;
            }
            tr:first-child td {
                 border-top:solid;
            }
            tr:nth-child(2n) td {
                border-bottom:solid ;
            }

            td{
                text-align: center;
                margin-left: 3px;
                height: 45px;
                width: 45px;
                font-size: 30px;
                font-weight: bold;
            }

            input{
                border: darkgray;
                text-align: center;
                margin-left: 3px;
                height: 45px;
                width: 45px;
                font-size: 30px;
                font-weight: bold;
            }
            table{
                width: 250px;
                height: 250px;
            }

            #holder {
                position: relative;
                padding-top: 200px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .container{
                padding-top:40px;
            }


    </style>
        <div class="container">
            <div class="row col-md-4 offset-md-5">
                <h4>Game of : &nbsp &nbsp</h4>
                <label id="label" style="font-size:21px"> 1</label><label id="total" style="font-size:21px" ></label>
            <!-- <h4 class="col-md-2 offset-md-4"> Game of :</h4>
            <label class="col-md-1" style="font-size:20px;">1</label> -->
            </div>
            <br/>
        <table class="sd" border="1" align="center" cellspacing="1">
            <tr>
                <td id="r0c0"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r0c1"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r0c2"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r0c3"><input class="sudoku" type="text" maxlength="1"></td>
             </tr>
            <tr>
                <td id="r1c0"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r1c1"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r1c2"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r1c3"><input class="sudoku" type="text" maxlength="1"></td>
            </tr>
            <tr>
                <td id="r2c0"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r2c1"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r2c2"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r2c3"><input class="sudoku" type="text" maxlength="1"></td>
            </tr>
            <tr>
                <td id="r3c0"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r3c1"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r3c2"><input class="sudoku" type="text" maxlength="1"></td>
                <td id="r3c3"><input class="sudoku" type="text" maxlength="1"></td>
            </tr>
        </table>
        <br>
        <div class="row col-md-6 offset-md-5">
            <button class="btn btn-primary btn-md" id="submit-button">Next Game</button>
            <button class="offset-md-1 btn btn-primary btn-md" id="stop">Skip</button>
        </div>
        <br>
{#        <div class="row col-md-6 offset-md-5" id="next" style="display: none;">#}
{#            <button button class="btn btn-primary btn-md" id="next-button">Next Homemade</button>#}
{#            {% next_button %}#}
{#        </div>#}
        <div style="display: none;">
            {{ form.game_attemptted }}
            {{ form.game_correctted }}
{#        {% formfield player.game_attemptted %}#}
{#        {% formfield player.game_correctted %}#}
{#        <input name="game_correctted" id="game_correctted"/>#}
{#        <input name="game_attemptted" id="game_attemptted"/>#}
        </div>
</div>
    <script src="{% static "sudoku/games.js" %}"></script>
<script>
            $(document).ready(function() {
                var counter = 0;
                var game_attempted = 0;
                var game_correct = 0;
                var games = getGames();
                $("#total").html("/"+ (games.length-1));

                buildGame();

                //function to transform each game(list fomr) to a two dimensonal array
                function generateGameData(list){
                    tdArray = [];
                    for (var i = 0; i<4; i++){
                        tdArray.push(list.slice(4*i,4*(i+1)));
                    };
                    return tdArray;
                }

                //function to populate the game board with data
                function buildGame(){
                    let data = generateGameData(games[counter])
                    for (var r = 0; r<4; r++){
                        for (var c = 0; c <4; c++){
                            let cellid = "#r" + r +"c" +c;
                            $(cellid).html('<input class="sudoku" maxlength="1">')
                            if (data[r][c] != ""){
                                $(cellid).html(data[r][c])
                            }
                        }
                    }
                }
                //button click function main function of this javascript
                $("#submit-button").click(function() {
                    counter += 1;
                    let number_games = counter;
                    let userBoard = loadUserBoard();
                    if(validateInput(userBoard)){
                        if (sudokuChecker(userBoard)){
                            game_attempted += 1;
                            game_correct +=1;
                        }
                        else {
                            game_attempted += 1;
                        }
                    }
                    else{
                        game_attempted += 1;
                    }

                    if (counter === games.length-2){
                        $('#submit-button').html("Finish");
                        $('#stop').hide();
                    }

                    if (counter === games.length -1){

                        {#$('#next').show();#}
                        {#$('#stop').hide();#}

                        $('#id_game_attemptted').html(game_attempted);
                        $('#id_game_attemptted').val(game_attempted);
                        $('#id_game_correctted').html(game_correct);
                        $('#id_game_correctted').val(game_correct);
                        //console.log(game_correct +"/" + game_attempted);
                        number_games = games.length-2;
                    }
                    number_games += 1;
                    $('#label').html(number_games);

                    buildGame();

                    //console.log(userBoard)
                    //console.log(counter)
                });

                //button to skip the game
                $('#stop').click(function(){
                    {#$('#submit-button').hide();#}
                    {#$('#next').show();#}
                    {#$('#stop').hide();#}
                    $('#id_game_attemptted').html(game_attempted);
                    $('#id_game_attemptted').val(game_attempted);
                    $('#id_game_correctted').html(game_correct);
                    $('#id_game_correctted').val(game_correct);

                    //console.log(game_correct +"/" + game_attempted);
                });

                function sudokuChecker(array) {
                    if (rowSum(array) && colsum(array) && gridSum(array))
                        return true;
                    return false;
                }

                //function to check if the answer is correct
                function rowSum(array){
                    let isCorrect = true;
                    for (var i = 0; i<4; i++){
                        if(sum(array[i]) !== 10){
                            isCorrect = false;
                            i = 4;
                        }
                    }
                    return isCorrect;
                }
                //check colmun sum
                function colsum(array){
                    let isCorrect = true;
                    for (var i = 0; i <4; i++){
                        if ((array[0][i] + array[1][i] + array[2][i] + array[3][i]) !== 10) {
                            isCorrect = false;
                            i = 4;
                        }
                    }
                    return isCorrect;
                }
                function gridSum(array){
                    let isCorrect = true;
                    for (var i = 0; i <1; i++){
                        if ((array[i][0] + array[i][1] + array[i+1][0] + array[i+1][1] !==10 && array[i][2] + array[i][3] + array[i+1][2] + array[i+1][3] !==10)){
                            isCorrect = false;
                            i = 2;
                        }
                    }
                    for (var i = 2; i <3; i++){
                        if ((array[i][0] + array[i][1] + array[i+1][0] + array[i+1][1] !==10 && array[i][2] + array[i][3] + array[i+1][2] + array[i+1][3] !==10)){
                            isCorrect = false;
                            i = 3;
                        }
                    }
                    return isCorrect;
                 }
                //function to validate input
                function validateInput(array){
                    let valid = false;
                    for (var i=0; i<4; i++){
                            for (var j=0; j<4; j++){
                            if (Number.isInteger(array[i][j]) && array[i][j] >= 1 && array[i][j] <= 4){
                                valid = true
                            }
                            else{
                                valid = false;
                                j = 4;
                                i = 4;
                            }
                        }
                    }
                    return valid;
                };
                //get user imports
                function loadUserBoard() {
                    let result = [new Array(4), new Array(4), new Array(4), new Array(4)];

                    for (var r = 0; r<4; r++){
                        for (var c=0; c<4; c++){
                            let cellid = "#r" + r +"c" +c;
                            let cellValue;
                            if ($(cellid).find("input")[0]){
                                cellValue = $(cellid).find("input").val();
                            }
                            else{
                                cellValue = $(cellid).html();
                            }
                            result[r][c] = parseInt(cellValue);
                        }
                    }
                    return result
                }

                function sum(array){
                    let sum =  0;
                    for (var i in array){
                        sum += array[i]
                    }
                    return sum;
                }

        });
        </script>
{% endblock %}
